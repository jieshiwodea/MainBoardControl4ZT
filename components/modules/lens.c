/*
 * lens.c
 *
 *  Created on: 2019年7月30日
 *      Author: wt
 */
#include "lens.h"
#include "tim.h"
#include "drv_uart.h"

int32_t lens_pid_register(struct lens *lens, const char *name)
{
	char motor_name[2][OBJECT_NAME_MAX_LEN] = {0};
	uint8_t name_len;
	int32_t err;

	if (lens == NULL)
		return -WT_INVAL;
	if (lens_find(name) != NULL)
		return -WT_EXISTED;

	object_init(&(lens->parent), Object_Class_Lens, name);

	name_len = strlen(name);

	if (name_len > OBJECT_NAME_MAX_LEN / 2)
	{
		name_len = OBJECT_NAME_MAX_LEN / 2;
	}

	for (int i = 0; i < 2; i++)
	{
		memcpy(&motor_name[i], name, name_len);
	}

	lens->motor[left_motor].encoder_tim_handle = &htim3;
	lens->motor[left_motor].pwm_tim_handle = &htim1;
	lens->motor[left_motor].pwm_channel = TIM_CHANNEL_2;
	lens->motor[left_motor].goto_zp_flag = TRUE;

	lens->motor[right_motor].encoder_tim_handle = &htim5;
	lens->motor[right_motor].pwm_tim_handle = &htim1;
	lens->motor[right_motor].pwm_channel = TIM_CHANNEL_1;
	lens->motor[right_motor].goto_zp_flag = TRUE;

	lens->auto_focus_flag = FALSE;

	memcpy(&motor_name[left_motor][name_len], "_LEFT\0", 6);
	memcpy(&motor_name[right_motor][name_len], "_RIGHT\0", 7);

	for (int i = 0; i < 2; i++)
	{
		err = motor_device_register(&(lens->motor[i]), motor_name[i], 0);
		if (err != WT_OK)
			goto end;
	}

	pid_struct_init(&(lens->motor_pid[left_motor]),  500, 0, 1.5, 0, 0);
	pid_struct_init(&(lens->motor_pid[right_motor]), 500, 0, 1.5, 0, 0);

	return WT_OK;
	end:
	object_detach(&(lens->parent));

	return err;
}


lens_t lens_find(const char *name)
{
	struct object *object;

	object = object_find(name, Object_Class_Lens);

	return (lens_t)object;
}

float motor_out;
int32_t lens_execute(struct lens *lens)
{
	if (lens == NULL)
		return -WT_INVAL;

	motor_out = pid_calculate(&(lens->motor_pid[left_motor]), __HAL_TIM_GET_COUNTER(&htim3), lens->motor[left_motor].target);
	motor_device_set_current(&(lens->motor[left_motor]), motor_out);


	motor_out = pid_calculate(&(lens->motor_pid[right_motor]), __HAL_TIM_GET_COUNTER(&htim5), lens->motor[right_motor].target);
	motor_device_set_current(&(lens->motor[right_motor]), motor_out);

	return WT_OK;
}

void lens_set_left_motor_target(int16_t target, struct lens *lens)
{
	//	taskENTER_CRITICAL();
	lens->motor[left_motor].target += target;
	VAL_LIMIT(lens->motor[left_motor].target,MOTOR_TARGET_MIN,MOTOR_TARGET_MAX);
	//	taskEXIT_CRITICAL();

}

void lens_set_right_motor_target(int16_t target, struct lens *lens)
{
	//	taskENTER_CRITICAL();
	lens->motor[right_motor].target  += target;
	VAL_LIMIT(lens->motor[right_motor].target,MOTOR_TARGET_MIN,MOTOR_TARGET_MAX);
	//	taskEXIT_CRITICAL();
}


#ifdef NEW_001
/* left motor */
static uint16_t left_motor_table[ENCODER_VALUE_LENGTH][2] ={{29,17700},{30,17790},{31,17800},{32,18383},{33,18966},{34,19549},{35,20132},{36,20715},{37,21300},{38,22047},{39,22794},{40,23541},{41,24290},
		{42,25165},{43,26040},{44,26915},{45,27790},{46,28004},{47,28218},{48,28432},{49,28646},{50,28860},{51,29074},
		{52,29290},{53,29443},{54,29596},{55,29749},{56,29902},{57,30055},{58,30208},{59,30361},{60,30514},{61,30667},
		{62,30820},{63,30973},{64,31126},{65,31290},{66,31504},{67,31718},{68,31932},{69,32146},{70,32360},{71,32574},
		{72,32788},{73,33002},{74,33216},{75,33430},{76,33644},{77,33858},{78,34072},{79,34286},{80,34500},{81,34714},
		{82,34928},{83,35142},{84,35356},{85,35570},{86,35790},{87,35905},{88,36020},{89,36135},{90,36250},{91,36365},
		{92,36480},{93,36595},{94,36710},{95,36825},{96,36940},{97,37055},{98,37170},{99,37285},{100,37400},{101,37515},
		{102,37630},{103,37745},{104,37860},{105,37975},{106,38090},{107,38205},{108,38320},{109,38435},{110,38550},{111,38665},
		{112,38790},{113,38826},{114,38862},{115,38898},{116,38934},{117,38970},{118,39006},{119,39042},{120,39078},{121,39114},
		{122,39150},{123,39186},{124,39222},{125,39258},{126,39294},{127,39330},{128,39366},{129,39402},{130,39438},{131,39474},
		{132,39510},{133,39546},{134,39582},{135,39618},{136,39654},{137,39690},{138,39726},{139,39762},{140,39800},{141,39829},
		{142,39858},{143,39887},{144,39916},{145,39945},{146,39974},{147,40003},{148,40032},{149,40061},{150,40090},{151,40119},
		{152,40148},{153,40177},{154,40206},{155,40235},{156,40264},{157,40293},{158,40322},{159,40351},{160,40380},{161,40409},
		{162,40438},{163,40467},{164,40496},{165,40525},{166,40554},{167,40583},{168,40612},{169,40641},{170,40670},{171,40699},
		{172,40728},{173,40757},{174,40786},{175,40815},{176,40844},{177,40873},{178,40902},{179,40931},{180,40960},{181,40989},
		{182,41018},{183,41047},{184,41076},{185,41105},{186,41134},{187,41163},{188,41192},{189,41221},{190,41290},{191,41315},
		{192,41340},{193,41365},{194,41390},{195,41415},{196,41440},{197,41465},{198,41490},{199,41515},{200,41540},{201,41565},
		{202,41590},{203,41615},{204,41640},{205,41665},{206,41690},{207,41715},{208,41740},{209,41765},{210,41790},{211,41815},
		{212,41840},{213,41865},{214,41890},{215,41915},{216,41940},{217,41965},{218,41990},{219,42015},{220,42040},{221,42065},
		{222,42090},{223,42115},{224,42140},{225,42165},{226,42190},{227,42215},{228,42240},{229,42265},{230,42300},{231,42302},
		{232,42304},{233,42306},{234,42308},{235,42310},{236,42312},{237,42314},{238,42316},{239,42318},{240,42320},{241,42322},
		{242,42324},{243,42326},{244,42328},{245,42330},{246,42332},{247,42334},{248,42336},{249,42338},{250,42340},{251,42342},
		{252,42344},{253,42346},{254,42348},{255,42350},{256,42352},{257,42354},{258,42356},{259,42358},{260,42360},{261,42362},
		{262,42364},{263,42366},{264,42368},{265,42370},{266,42372},{267,42374},{268,42376},{269,42378},{270,42380},{271,42382},
		{272,42384},{273,42386},{274,42388},{275,42390},{276,42392},{277,42394},{278,42396},{279,42398},{280,42400},{281,42402},
		{282,42404},{283,42406},{284,42408},{285,42410},{286,42412},{287,42414},{288,42416},{289,42418},{290,42420},{291,42422},
		{292,42424},{293,42426},{294,42428},{295,42430},{296,42432},{297,42434},{298,42436},{299,42438},{300,42500},{350,42600},{400,42700}};
/* right motor */
static uint16_t right_motor_table[ENCODER_VALUE_LENGTH][2] = {{29,1500},{30,1580},{31,1600},{32,1849},{33,2098},{34,2347},{35,2596},{36,2845},{37,3097},{38,4697},{39,6297},{40,7897},{41,9500},
		{42,10250},{43,11000},{44,11750},{45,12500},{46,12871},{47,13242},{48,13613},{49,13984},{50,14355},{51,14726},
		{52,15100},{53,15292},{54,15484},{55,15676},{56,15868},{57,16060},{58,16252},{59,16444},{60,16636},{61,16828},
		{62,17020},{63,17212},{64,17404},{65,17600},{66,17766},{67,17932},{68,18098},{69,18264},{70,18430},{71,18596},
		{72,18762},{73,18928},{74,19094},{75,19260},{76,19426},{77,19592},{78,19758},{79,19924},{80,20090},{81,20256},
		{82,20422},{83,20588},{84,20754},{85,20920},{86,21100},{87,21234},{88,21368},{89,21502},{90,21636},{91,21770},
		{92,21904},{93,22038},{94,22172},{95,22306},{96,22440},{97,22574},{98,22708},{99,22842},{100,22976},{101,23110},
		{102,23244},{103,23378},{104,23512},{105,23646},{106,23780},{107,23914},{108,24048},{109,24182},{110,24316},{111,24450},
		{112,24600},{113,24635},{114,24670},{115,24705},{116,24740},{117,24775},{118,24810},{119,24845},{120,24880},{121,24915},
		{122,24950},{123,24985},{124,25020},{125,25055},{126,25090},{127,25125},{128,25160},{129,25195},{130,25230},{131,25265},
		{132,25300},{133,25335},{134,25370},{135,25405},{136,25440},{137,25475},{138,25510},{139,25545},{140,25600},{141,25650},
		{142,25700},{143,25750},{144,25800},{145,25850},{146,25900},{147,25950},{148,26000},{149,26050},{150,26100},{151,26150},
		{152,26200},{153,26250},{154,26300},{155,26350},{156,26400},{157,26450},{158,26500},{159,26550},{160,26600},{161,26650},
		{162,26700},{163,26750},{164,26800},{165,26850},{166,26900},{167,26950},{168,27000},{169,27050},{170,27100},{171,27150},
		{172,27200},{173,27250},{174,27300},{175,27350},{176,27400},{177,27450},{178,27500},{179,27550},{180,27600},{181,27650},
		{182,27700},{183,27750},{184,27800},{185,27850},{186,27900},{187,27950},{188,28000},{189,28050},{190,28100},{191,28150},
		{192,28200},{193,28250},{194,28300},{195,28350},{196,28400},{197,28450},{198,28500},{199,28550},{200,28600},{201,28650},
		{202,28700},{203,28750},{204,28800},{205,28850},{206,28900},{207,28950},{208,29000},{209,29050},{210,29100},{211,29150},
		{212,29200},{213,29250},{214,29300},{215,29350},{216,29400},{217,29450},{218,29500},{219,29550},{220,29600},{221,29650},
		{222,29700},{223,29750},{224,29800},{225,29850},{226,29900},{227,29950},{228,30000},{229,30050},{230,30100},{231,30102},
		{232,30104},{233,30106},{234,30108},{235,30110},{236,30112},{237,30114},{238,30116},{239,30118},{240,30120},{241,30122},
		{242,30124},{243,30126},{244,30128},{245,30130},{246,30132},{247,30134},{248,30136},{249,30138},{250,30140},{251,30142},
		{252,30144},{253,30146},{254,30148},{255,30150},{256,30152},{257,30154},{258,30156},{259,30158},{260,30160},{261,30162},
		{262,30164},{263,30166},{264,30168},{265,30170},{266,30172},{267,30174},{268,30176},{269,30178},{270,30180},{271,30182},
		{272,30184},{273,30186},{274,30188},{275,30190},{276,30192},{277,30194},{278,30196},{279,30198},{280,30200},{281,30202},
		{282,30204},{283,30206},{284,30208},{285,30210},{286,30212},{287,30214},{288,30216},{289,30218},{290,30220},{291,30222},
		{292,30224},{293,30226},{294,30228},{295,30230},{296,30232},{297,30234},{298,30236},{299,30238},{300,30300},{350,30400},{400,30500}};
#endif


#ifdef NEW_002
/* left motor */
static uint16_t left_motor_table[ENCODER_VALUE_LENGTH][2] ={{18,514},{19,816},{20,1118},{21,1220},{22,1322},{23,1424},{24,1526},{25,1630},{26,1668},{27,1706},{28,1744},
		{29,1782},{30,1822},{31,1873},{32,1924},{33,1975},{34,2026},{35,2079},{36,2129},{37,2179},{38,2229},
		{39,2281},{40,2298},{41,2315},{42,2332},{43,2349},{44,2366},{45,2383},{46,2400},{47,2417},{48,2434},
		{49,2451},{50,2470},{51,2488},{52,2506},{53,2524},{54,2542},{55,2560},{56,2578},{57,2596},{58,2614},
		{59,2632},{60,2654},{61,2665},{62,2676},{63,2687},{64,2698},{65,2709},{66,2720},{67,2731},{68,2742},
		{69,2753},{70,2764},{71,2775},{72,2786},{73,2797},{74,2808},{75,2819},{76,2845},{77,2850},{78,2855},
		{79,2860},{80,2865},{81,2870},{82,2875},{83,2880},{84,2885},{85,2890},{86,2895},{87,2900},{88,2905},
		{89,2910},{90,2915},{91,2920},{92,2925},{93,2930},{94,2935},{95,2940},{96,2945},{97,2950},{98,2973},
		{99,2973},{100,2973},{101,2973},{102,2973},{103,2973},{104,2973},{105,2973},{106,2973},{107,2973},{108,2973},
		{109,2973},{110,2973},{111,2973},{112,2973},{113,2973},{114,2973},{115,2973},{116,2978},{117,2978},{118,2978},
		{119,2978},{120,2978},{121,2978},{122,2978},{123,2978},{124,2978},{125,2978},{126,2978},{127,2978},{128,2978},
		{129,2978},{130,2978},{131,2978},{132,2978},{133,2978},{134,2978},{135,2978},{136,2978},{137,2978},{138,2978},
		{139,2978},{140,2978},{141,2978},{142,2980},{143,2980},{144,2980},{145,2980},{146,2980},{147,2980},{148,2980},
		{149,2980},{150,2980},{151,2980},{152,2980},{153,2980},{154,2980},{155,2980},{156,2980},{157,2980},{158,2980},
		{159,2980},{160,2980},{161,2980},{162,2980},{163,2980},{164,2980},{165,2980},{166,2980},{167,2980},{168,2980},
		{169,2980},{170,2980},{171,2980},{172,2982},{173,2986},{174,2990},{175,2994},{176,2998},{177,3002},{178,3006},
		{179,3010},{180,3014},{181,3018},{182,3022},{183,3026},{184,3030},{185,3034},{186,3038},{187,3042},{188,3046},
		{189,3050},{190,3054},{191,3058},{192,3062},{193,3066},{194,3070},{195,3074},{196,3078},{197,3082},{198,3086},
		{199,3090},{200,3094},{201,3098},{202,3102},{203,3106},{204,3110},{205,3114},{206,3118},{207,3122},{208,3126},
		{209,3130},{210,3134},{211,3138},{212,3142},{213,3146},{214,3150},{215,3154},{216,3158},{217,3162},{218,3166},
		{219,3170},{220,3174},{221,3178},{222,3182},{223,3186},{224,3190},{225,3194},{226,3198},{227,3202},{228,3206},
		{229,3210},{230,3214},{231,3218},{232,3222},{233,3226},{234,3230},{235,3248},{236,3253},{237,3258},{238,3263},
		{239,3268},{240,3273},{241,3278},{242,3283},{243,3288},{244,3293},{245,3298},{246,3303},{247,3308},{248,3313},
		{249,3318},{250,3323},{251,3328},{252,3333},{253,3338},{254,3343},{255,3348},{256,3353},{257,3358},{258,3363},
		{259,3368},{260,3373},{261,3378},{262,3383},{263,3388},{264,3393},{265,3398},{266,3403},{267,3408},{268,3413},
		{269,3418},{270,3448},{271,3451},{272,3454},{273,3457},{274,3460},{275,3463},{276,3466},{277,3469},{278,3472},
		{279,3475},{280,3478},{281,3481},{282,3484},{283,3487},{284,3490},{285,3493},{286,3496},{287,3499},{288,3502},
		{289,3505},{290,3508},{291,3511},{292,3514},{293,3517},{294,3520},{295,3523},{296,3526},{297,3529},{298,3532},
		{299,3535},{300,3548},{301,3548},{302,3548},{303,3548},{304,3548},{305,3548},{306,3548},{307,3548},{308,3548},
		{309,3548},{310,3548},{311,3548},{312,3548},{313,3548},{314,3548},{315,3548},{316,3548},{317,3548},{318,3548},
		{319,3548},{320,3548},{321,3548},{322,3548},{323,3548},{324,3548},{325,3548},{326,3548},{327,3548},{328,3548},
		{329,3548},{330,3548},{331,3548},{332,3548},{333,3548},{334,3548},{335,3548},{336,3548},{337,3548},{338,3548},
		{339,3548},{340,3548},{341,3548},{342,3548},{343,3548},{344,3548},{345,3548},{346,3548},{347,3548},{348,3548},
		{349,3548},{350,3548},{351,3548},{352,3548},{353,3548},{354,3548},{355,3548},{356,3548},{357,3548},{358,3548},
		{359,3548},{360,3548},{361,3548},{362,3548},{363,3548},{364,3548},{365,3548},{366,3548},{367,3548},{368,3548},
		{369,3548},{370,3548},{371,3548},{372,3548},{373,3548},{374,3548},{375,3548},{376,3548},{377,3548},{378,3548},
		{379,3548},{380,3548},{381,3548},{382,3548},{383,3548},{384,3548},{385,3548},{386,3548},{387,3548},{388,3548},
		{389,3548},{390,3548},{391,3548},{392,3548},{393,3548},{394,3548},{395,3548},{396,3548},{397,3548},{398,3548},
		{399,3548},{400,3600},};
/* right motor */
static uint16_t right_motor_table[ENCODER_VALUE_LENGTH][2] = {{18,893},{19,1036},{20,1179},{21,1256},{22,1333},{23,1410},{24,1487},{25,1565},{26,1667},{27,1769},{28,1871},
		{29,1973},{30,2077},{31,2109},{32,2141},{33,2173},{34,2205},{35,2237},{36,2284},{37,2331},{38,2378},
		{39,2427},{40,2450},{41,2473},{42,2496},{43,2519},{44,2542},{45,2565},{46,2588},{47,2611},{48,2634},
		{49,2657},{50,2682},{51,2694},{52,2706},{53,2718},{54,2730},{55,2742},{56,2754},{57,2766},{58,2778},
		{59,2790},{60,2811},{61,2817},{62,2823},{63,2829},{64,2835},{65,2841},{66,2847},{67,2853},{68,2859},
		{69,2865},{70,2871},{71,2877},{72,2883},{73,2889},{74,2895},{75,2901},{76,2907},{77,2920},{78,2933},
		{79,2946},{80,2959},{81,2972},{82,2985},{83,2998},{84,3011},{85,3024},{86,3037},{87,3050},{88,3063},
		{89,3076},{90,3089},{91,3102},{92,3115},{93,3128},{94,3141},{95,3154},{96,3167},{97,3180},{98,3197},
		{99,3200},{100,3203},{101,3206},{102,3209},{103,3212},{104,3215},{105,3218},{106,3221},{107,3224},{108,3227},
		{109,3230},{110,3233},{111,3236},{112,3239},{113,3242},{114,3245},{115,3248},{116,3259},{117,3259},{118,3259},
		{119,3259},{120,3259},{121,3259},{122,3259},{123,3259},{124,3259},{125,3259},{126,3259},{127,3259},{128,3259},
		{129,3259},{130,3259},{131,3259},{132,3259},{133,3259},{134,3259},{135,3259},{136,3259},{137,3259},{138,3259},
		{139,3259},{140,3259},{141,3259},{142,3262},{143,3265},{144,3268},{145,3271},{146,3274},{147,3277},{148,3280},
		{149,3283},{150,3286},{151,3289},{152,3292},{153,3295},{154,3298},{155,3301},{156,3304},{157,3307},{158,3310},
		{159,3313},{160,3316},{161,3319},{162,3322},{163,3325},{164,3328},{165,3331},{166,3334},{167,3337},{168,3340},
		{169,3343},{170,3346},{171,3349},{172,3357},{173,3358},{174,3359},{175,3360},{176,3361},{177,3362},{178,3363},
		{179,3364},{180,3365},{181,3366},{182,3367},{183,3368},{184,3369},{185,3370},{186,3371},{187,3372},{188,3373},
		{189,3374},{190,3375},{191,3376},{192,3377},{193,3378},{194,3379},{195,3380},{196,3381},{197,3382},{198,3383},
		{199,3384},{200,3385},{201,3386},{202,3387},{203,3388},{204,3389},{205,3390},{206,3391},{207,3392},{208,3393},
		{209,3394},{210,3395},{211,3396},{212,3397},{213,3398},{214,3399},{215,3400},{216,3401},{217,3402},{218,3403},
		{219,3404},{220,3405},{221,3406},{222,3407},{223,3408},{224,3409},{225,3410},{226,3411},{227,3412},{228,3413},
		{229,3414},{230,3415},{231,3416},{232,3417},{233,3418},{234,3419},{235,3451},{236,3456},{237,3461},{238,3466},
		{239,3471},{240,3476},{241,3481},{242,3486},{243,3491},{244,3496},{245,3501},{246,3506},{247,3511},{248,3516},
		{249,3521},{250,3526},{251,3531},{252,3536},{253,3541},{254,3546},{255,3551},{256,3556},{257,3561},{258,3566},
		{259,3571},{260,3576},{261,3581},{262,3586},{263,3591},{264,3596},{265,3601},{266,3606},{267,3611},{268,3616},
		{269,3621},{270,3651},{271,3654},{272,3657},{273,3660},{274,3663},{275,3666},{276,3669},{277,3672},{278,3675},
		{279,3678},{280,3681},{281,3684},{282,3687},{283,3690},{284,3693},{285,3696},{286,3699},{287,3702},{288,3705},
		{289,3708},{290,3711},{291,3714},{292,3717},{293,3720},{294,3723},{295,3726},{296,3729},{297,3732},{298,3735},
		{299,3738},{300,3751},{301,3751},{302,3751},{303,3751},{304,3751},{305,3751},{306,3751},{307,3751},{308,3751},
		{309,3751},{310,3751},{311,3751},{312,3751},{313,3751},{314,3751},{315,3751},{316,3751},{317,3751},{318,3751},
		{319,3751},{320,3751},{321,3751},{322,3751},{323,3751},{324,3751},{325,3751},{326,3751},{327,3751},{328,3751},
		{329,3751},{330,3751},{331,3751},{332,3751},{333,3751},{334,3751},{335,3751},{336,3751},{337,3751},{338,3751},
		{339,3751},{340,3751},{341,3751},{342,3751},{343,3751},{344,3751},{345,3751},{346,3751},{347,3751},{348,3751},
		{349,3751},{350,3751},{351,3751},{352,3751},{353,3751},{354,3751},{355,3751},{356,3751},{357,3751},{358,3751},
		{359,3751},{360,3751},{361,3751},{362,3751},{363,3751},{364,3751},{365,3751},{366,3751},{367,3751},{368,3751},
		{369,3751},{370,3751},{371,3751},{372,3751},{373,3751},{374,3751},{375,3751},{376,3751},{377,3751},{378,3751},
		{379,3751},{380,3751},{381,3751},{382,3751},{383,3751},{384,3751},{385,3751},{386,3751},{387,3751},{388,3751},
		{389,3751},{390,3751},{391,3751},{392,3751},{393,3751},{394,3751},{395,3751},{396,3751},{397,3751},{398,3751},
		{399,3751},{400,3800},};
#endif


void lens_set_motors_target_by_distance(uint16_t distance, struct lens *lens)
{
	uint16_t i = 0;
	if( (distance>300) && (distance<=350) )
	{
		distance = 350;
	}
	else if( distance>350 )
	{
		distance = 400;
	}

	if(distance<=28)
	{
		lens->motor[left_motor].target = left_motor_zp;
		lens->motor[right_motor].target = right_motor_zp;
		return;
	}

	for(i=0; i < ENCODER_VALUE_LENGTH; i++)
	{
		if(left_motor_table[i][0] == distance)
		{
			lens->motor[left_motor].target = left_motor_table[i][1];
			break;
		}
	}

	for(i=0; i < ENCODER_VALUE_LENGTH; i++)
	{
		if(right_motor_table[i][0] == distance)
		{
			lens->motor[right_motor].target = right_motor_table[i][1];
			break;
		}
	}
}
